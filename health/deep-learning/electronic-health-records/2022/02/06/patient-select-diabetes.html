<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Patient Selection for Diabetes Drug Testing | livingdatalab</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Patient Selection for Diabetes Drug Testing" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Utilizing a synthetic Diabetes patient dataset, we will create a deep learning model trained on EHR data (Electronic Health Records) to find suitable patients for testing a new Diabetes drug." />
<meta property="og:description" content="Utilizing a synthetic Diabetes patient dataset, we will create a deep learning model trained on EHR data (Electronic Health Records) to find suitable patients for testing a new Diabetes drug." />
<link rel="canonical" href="https://www.livingdatalab.com/health/deep-learning/electronic-health-records/2022/02/06/patient-select-diabetes.html" />
<meta property="og:url" content="https://www.livingdatalab.com/health/deep-learning/electronic-health-records/2022/02/06/patient-select-diabetes.html" />
<meta property="og:site_name" content="livingdatalab" />
<meta property="og:image" content="https://www.livingdatalab.com/images/artificial-intelligence-medical.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-06T00:00:00-06:00" />
<script type="application/ld+json">
{"url":"https://www.livingdatalab.com/health/deep-learning/electronic-health-records/2022/02/06/patient-select-diabetes.html","@type":"BlogPosting","headline":"Patient Selection for Diabetes Drug Testing","dateModified":"2022-02-06T00:00:00-06:00","datePublished":"2022-02-06T00:00:00-06:00","image":"https://www.livingdatalab.com/images/artificial-intelligence-medical.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.livingdatalab.com/health/deep-learning/electronic-health-records/2022/02/06/patient-select-diabetes.html"},"description":"Utilizing a synthetic Diabetes patient dataset, we will create a deep learning model trained on EHR data (Electronic Health Records) to find suitable patients for testing a new Diabetes drug.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://www.livingdatalab.com/feed.xml" title="livingdatalab" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-91568149-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">livingdatalab</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Livingdatalab</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Patient Selection for Diabetes Drug Testing</h1><p class="page-description">Utilizing a synthetic Diabetes patient dataset, we will create a deep learning model trained on EHR data (Electronic Health Records) to find suitable patients for testing a new Diabetes drug.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-02-06T00:00:00-06:00" itemprop="datePublished">
        Feb 6, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      17 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#health">health</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#deep-learning">deep-learning</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#electronic-health-records">electronic-health-records</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h2"><a href="#approach">Approach</a></li>
<li class="toc-entry toc-h2"><a href="#dataset">Dataset</a></li>
<li class="toc-entry toc-h2"><a href="#dataset-loading-and-schema-review">Dataset Loading and Schema Review</a>
<ul>
<li class="toc-entry toc-h3"><a href="#determine-level-of-dataset-line-or-encounter">Determine Level of Dataset (Line or Encounter)</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#analyze-dataset">Analyze Dataset</a>
<ul>
<li class="toc-entry toc-h3"><a href="#analysis-key-findings">Analysis key findings</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#reduce-dimensionality-of-the-ndc-code-feature">Reduce Dimensionality of the NDC Code Feature</a></li>
<li class="toc-entry toc-h2"><a href="#select-first-encounter-for-each-patient">Select First Encounter for each Patient</a></li>
<li class="toc-entry toc-h2"><a href="#aggregate-dataset-to-right-level-for-modelling">Aggregate Dataset to Right Level for Modelling</a></li>
<li class="toc-entry toc-h2"><a href="#prepare-fields-and-cast-dataset">Prepare Fields and Cast Dataset</a>
<ul>
<li class="toc-entry toc-h3"><a href="#feature-selection">Feature Selection</a></li>
<li class="toc-entry toc-h3"><a href="#preprocess-dataset---casting-and-imputing">Preprocess Dataset - Casting and Imputing</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#split-dataset-into-train-validation-and-test-partitions">Split Dataset into Train, Validation, and Test Partitions</a></li>
<li class="toc-entry toc-h2"><a href="#demographic-representation-analysis-of-split">Demographic Representation Analysis of Split</a>
<ul>
<li class="toc-entry toc-h3"><a href="#label-distribution-across-partitions">Label Distribution Across Partitions</a></li>
<li class="toc-entry toc-h3"><a href="#demographic-group-analysis">Demographic Group Analysis</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#convert-dataset-splits-to-tf-dataset">Convert Dataset Splits to TF Dataset</a></li>
<li class="toc-entry toc-h2"><a href="#create-features">Create Features</a>
<ul>
<li class="toc-entry toc-h3"><a href="#create-categorical-features-with-tf-feature-columns">Create Categorical Features with TF Feature Columns</a></li>
<li class="toc-entry toc-h3"><a href="#create-categorical-features-with-tensorflow-feature-column-api">Create Categorical Features with Tensorflow Feature Column API</a></li>
<li class="toc-entry toc-h3"><a href="#create-numerical-features-with-tf-feature-columns">Create Numerical Features with TF Feature Columns</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#build-deep-learning-regression-model-with-sequential-api-and-tf-probability-layers">Build Deep Learning Regression Model with Sequential API and TF Probability Layers</a>
<ul>
<li class="toc-entry toc-h3"><a href="#use-densefeatures-to-combine-features-for-model">Use DenseFeatures to combine features for model</a></li>
<li class="toc-entry toc-h3"><a href="#build-sequential-api-model-from-densefeatures-and-tf-probability-layers">Build Sequential API Model from DenseFeatures and TF Probability Layers</a></li>
<li class="toc-entry toc-h3"><a href="#show-model-uncertainty-range-with-tf-probability">Show Model Uncertainty Range with TF Probability</a></li>
<li class="toc-entry toc-h3"><a href="#show-prediction-output">Show Prediction Output</a></li>
<li class="toc-entry toc-h3"><a href="#convert-regression-output-to-classification-output-for-patient-selection">Convert Regression Output to Classification Output for Patient Selection</a></li>
<li class="toc-entry toc-h3"><a href="#add-binary-prediction-to-test-dataframe">Add Binary Prediction to Test Dataframe</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#model-evaluation-metrics">Model Evaluation Metrics</a></li>
<li class="toc-entry toc-h2"><a href="#evaluating-potential-model-biases-with-aequitas-toolkit">Evaluating Potential Model Biases with Aequitas Toolkit</a>
<ul>
<li class="toc-entry toc-h3"><a href="#prepare-data-for-aequitas-bias-toolkit">Prepare Data For Aequitas Bias Toolkit</a></li>
<li class="toc-entry toc-h3"><a href="#reference-group-selection">Reference Group Selection</a></li>
<li class="toc-entry toc-h3"><a href="#race-and-gender-bias-analysis-for-patient-selection">Race and Gender Bias Analysis for Patient Selection</a></li>
<li class="toc-entry toc-h3"><a href="#fairness-analysis-example---relative-to-a-reference-group">Fairness Analysis Example - Relative to a Reference Group</a></li>
</ul>
</li>
</ul><h2 id="introduction">
<a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h2>

<p>EHR data is becoming a key source of real-world evidence (RWE) for the pharmaceutical industry and regulators to <a href="https://www.fda.gov/news-events/speeches-fda-officials/breaking-down-barriers-between-clinical-trials-and-clinical-care-incorporating-real-world-evidence">make decisions on clinical trials</a>.</p>

<p>For this project, we have a groundbreaking diabetes drug that is ready for clinical trial testing. It is a very unique and sensitive drug that requires administering the drug over at least 5-7 days of time in the hospital with frequent monitoring/testing and patient medication adherence training with a mobile application. We have been provided a patient dataset from a client partner and are tasked with building a predictive model that can identify which type of patients the company should focus their efforts testing this drug on. Target patients are people that are likely to be in the hospital for this duration of time and will not incur significant additional costs for administering this drug to the patient and monitoring.</p>

<p>In order to achieve our goal we must build a regression model that can predict the estimated hospitalization time for a patient and use this to select/filter patients for this study.</p>

<h2 id="approach">
<a class="anchor" href="#approach" aria-hidden="true"><span class="octicon octicon-link"></span></a>Approach</h2>

<p>Utilizing a synthetic dataset (denormalized at the line level augmentation) built off of the UCI Diabetes readmission dataset, we will build a regression model that predicts the expected days of hospitalization time and then convert this to a binary prediction of whether to include or exclude that patient from the clinical trial.</p>

<p>This project will demonstrate the importance of building the right data representation at the encounter level, with appropriate filtering and preprocessing/feature engineering of key medical code sets. We will also analyze and interpret the model for biases across key demographic groups.</p>

<h2 id="dataset">
<a class="anchor" href="#dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dataset</h2>

<p>Due to healthcare PHI regulations (HIPAA, HITECH), there are limited number of publicly available datasets and some datasets require training and approval. So, for the purpose of this study, we are using a dataset from <a href="https://archive.ics.uci.edu/ml/datasets/Diabetes+130-US+hospitals+for+years+1999-2008">UC Irvine</a> that has been modified.</p>

<h2 id="dataset-loading-and-schema-review">
<a class="anchor" href="#dataset-loading-and-schema-review" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dataset Loading and Schema Review</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataset_path</span> <span class="o">=</span> <span class="s">"./data/final_project_dataset.csv"</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Show first few rows
</span><span class="n">df</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>encounter_id</th>
      <th>patient_nbr</th>
      <th>race</th>
      <th>gender</th>
      <th>age</th>
      <th>weight</th>
      <th>admission_type_id</th>
      <th>discharge_disposition_id</th>
      <th>admission_source_id</th>
      <th>time_in_hospital</th>
      <th>payer_code</th>
      <th>medical_specialty</th>
      <th>primary_diagnosis_code</th>
      <th>other_diagnosis_codes</th>
      <th>number_outpatient</th>
      <th>number_inpatient</th>
      <th>number_emergency</th>
      <th>num_lab_procedures</th>
      <th>number_diagnoses</th>
      <th>num_medications</th>
      <th>num_procedures</th>
      <th>ndc_code</th>
      <th>max_glu_serum</th>
      <th>A1Cresult</th>
      <th>change</th>
      <th>readmitted</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2278392</td>
      <td>8222157</td>
      <td>Caucasian</td>
      <td>Female</td>
      <td>[0-10)</td>
      <td>?</td>
      <td>6</td>
      <td>25</td>
      <td>1</td>
      <td>1</td>
      <td>?</td>
      <td>Pediatrics-Endocrinology</td>
      <td>250.83</td>
      <td>?|?</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>41</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>NaN</td>
      <td>None</td>
      <td>None</td>
      <td>No</td>
      <td>NO</td>
    </tr>
    <tr>
      <th>1</th>
      <td>149190</td>
      <td>55629189</td>
      <td>Caucasian</td>
      <td>Female</td>
      <td>[10-20)</td>
      <td>?</td>
      <td>1</td>
      <td>1</td>
      <td>7</td>
      <td>3</td>
      <td>?</td>
      <td>?</td>
      <td>276</td>
      <td>250.01|255</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>59</td>
      <td>9</td>
      <td>18</td>
      <td>0</td>
      <td>68071-1701</td>
      <td>None</td>
      <td>None</td>
      <td>Ch</td>
      <td>&gt;30</td>
    </tr>
    <tr>
      <th>2</th>
      <td>64410</td>
      <td>86047875</td>
      <td>AfricanAmerican</td>
      <td>Female</td>
      <td>[20-30)</td>
      <td>?</td>
      <td>1</td>
      <td>1</td>
      <td>7</td>
      <td>2</td>
      <td>?</td>
      <td>?</td>
      <td>648</td>
      <td>250|V27</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>11</td>
      <td>6</td>
      <td>13</td>
      <td>5</td>
      <td>0378-1110</td>
      <td>None</td>
      <td>None</td>
      <td>No</td>
      <td>NO</td>
    </tr>
    <tr>
      <th>3</th>
      <td>500364</td>
      <td>82442376</td>
      <td>Caucasian</td>
      <td>Male</td>
      <td>[30-40)</td>
      <td>?</td>
      <td>1</td>
      <td>1</td>
      <td>7</td>
      <td>2</td>
      <td>?</td>
      <td>?</td>
      <td>8</td>
      <td>250.43|403</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>44</td>
      <td>7</td>
      <td>16</td>
      <td>1</td>
      <td>68071-1701</td>
      <td>None</td>
      <td>None</td>
      <td>Ch</td>
      <td>NO</td>
    </tr>
    <tr>
      <th>4</th>
      <td>16680</td>
      <td>42519267</td>
      <td>Caucasian</td>
      <td>Male</td>
      <td>[40-50)</td>
      <td>?</td>
      <td>1</td>
      <td>1</td>
      <td>7</td>
      <td>1</td>
      <td>?</td>
      <td>?</td>
      <td>197</td>
      <td>157|250</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>51</td>
      <td>5</td>
      <td>8</td>
      <td>0</td>
      <td>0049-4110</td>
      <td>None</td>
      <td>None</td>
      <td>Ch</td>
      <td>NO</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="determine-level-of-dataset-line-or-encounter">
<a class="anchor" href="#determine-level-of-dataset-line-or-encounter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Determine Level of Dataset (Line or Encounter)</h3>

<p>Given there are only 101766 unique encounter_id’s yet there are 143424 rows that are not nulls, this looks like the dataset is at the line level.</p>

<p>We would also want to aggregate on the primary_diagnosis_code as there is also only one of these per encounter. By aggregating on these 3 columns, we can create a encounter level dataset.</p>

<h2 id="analyze-dataset">
<a class="anchor" href="#analyze-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analyze Dataset</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Look at range of values &amp; key stats for numerical columns
</span><span class="n">numerical_feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">'time_in_hospital'</span><span class="p">,</span>  <span class="s">'number_outpatient'</span><span class="p">,</span> <span class="s">'number_inpatient'</span><span class="p">,</span> <span class="s">'number_emergency'</span><span class="p">,</span> <span class="s">'num_lab_procedures'</span><span class="p">,</span> <span class="s">'number_diagnoses'</span><span class="p">,</span> <span class="s">'num_medications'</span><span class="p">,</span> <span class="s">'num_procedures'</span> <span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="n">numerical_feature_list</span><span class="p">].</span><span class="n">describe</span><span class="p">()</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time_in_hospital</th>
      <th>number_outpatient</th>
      <th>number_inpatient</th>
      <th>number_emergency</th>
      <th>num_lab_procedures</th>
      <th>number_diagnoses</th>
      <th>num_medications</th>
      <th>num_procedures</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>143424.000000</td>
      <td>143424.000000</td>
      <td>143424.000000</td>
      <td>143424.000000</td>
      <td>143424.000000</td>
      <td>143424.000000</td>
      <td>143424.000000</td>
      <td>143424.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>4.490190</td>
      <td>0.362429</td>
      <td>0.600855</td>
      <td>0.195086</td>
      <td>43.255745</td>
      <td>7.424434</td>
      <td>16.776035</td>
      <td>1.349021</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2.999667</td>
      <td>1.249295</td>
      <td>1.207934</td>
      <td>0.920410</td>
      <td>19.657319</td>
      <td>1.924872</td>
      <td>8.397130</td>
      <td>1.719104</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>32.000000</td>
      <td>6.000000</td>
      <td>11.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>4.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>44.000000</td>
      <td>8.000000</td>
      <td>15.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>6.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>57.000000</td>
      <td>9.000000</td>
      <td>21.000000</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>14.000000</td>
      <td>42.000000</td>
      <td>21.000000</td>
      <td>76.000000</td>
      <td>132.000000</td>
      <td>16.000000</td>
      <td>81.000000</td>
      <td>6.000000</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define utility functions
</span><span class="k">def</span> <span class="nf">create_cardinality_feature</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">random_code_list</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">random_code_list</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">count_unique_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cat_col_list</span><span class="p">):</span>
    <span class="n">cat_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cat_col_list</span><span class="p">]</span>
    <span class="n">cat_df</span><span class="p">[</span><span class="s">'principal_diagnosis_code'</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_cardinality_feature</span><span class="p">(</span><span class="n">cat_df</span><span class="p">)</span>
    <span class="c1">#add feature with high cardinality
</span>    <span class="n">val_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">'columns'</span><span class="p">:</span> <span class="n">cat_df</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span>
                       <span class="s">'cardinality'</span><span class="p">:</span> <span class="n">cat_df</span><span class="p">.</span><span class="n">nunique</span><span class="p">()</span> <span class="p">}</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">val_df</span>

<span class="n">categorical_feature_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s">'race'</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">,</span> <span class="s">'weight'</span><span class="p">,</span> <span class="s">'payer_code'</span><span class="p">,</span> <span class="s">'medical_specialty'</span><span class="p">,</span> <span class="s">'primary_diagnosis_code'</span><span class="p">,</span> <span class="s">'other_diagnosis_codes'</span><span class="p">,</span><span class="s">'ndc_code'</span><span class="p">,</span> <span class="s">'max_glu_serum'</span><span class="p">,</span> <span class="s">'A1Cresult'</span><span class="p">,</span> <span class="s">'change'</span><span class="p">,</span> <span class="s">'readmitted'</span><span class="p">]</span>

<span class="n">categorical_df</span> <span class="o">=</span> <span class="n">count_unique_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">categorical_feature_list</span><span class="p">)</span>
<span class="n">categorical_df</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>columns</th>
      <th>cardinality</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>race</th>
      <td>race</td>
      <td>6</td>
    </tr>
    <tr>
      <th>gender</th>
      <td>gender</td>
      <td>3</td>
    </tr>
    <tr>
      <th>age</th>
      <td>age</td>
      <td>10</td>
    </tr>
    <tr>
      <th>weight</th>
      <td>weight</td>
      <td>10</td>
    </tr>
    <tr>
      <th>payer_code</th>
      <td>payer_code</td>
      <td>18</td>
    </tr>
    <tr>
      <th>medical_specialty</th>
      <td>medical_specialty</td>
      <td>73</td>
    </tr>
    <tr>
      <th>primary_diagnosis_code</th>
      <td>primary_diagnosis_code</td>
      <td>717</td>
    </tr>
    <tr>
      <th>other_diagnosis_codes</th>
      <td>other_diagnosis_codes</td>
      <td>19374</td>
    </tr>
    <tr>
      <th>ndc_code</th>
      <td>ndc_code</td>
      <td>251</td>
    </tr>
    <tr>
      <th>max_glu_serum</th>
      <td>max_glu_serum</td>
      <td>4</td>
    </tr>
    <tr>
      <th>A1Cresult</th>
      <td>A1Cresult</td>
      <td>4</td>
    </tr>
    <tr>
      <th>change</th>
      <td>change</td>
      <td>2</td>
    </tr>
    <tr>
      <th>readmitted</th>
      <td>readmitted</td>
      <td>3</td>
    </tr>
    <tr>
      <th>principal_diagnosis_code</th>
      <td>principal_diagnosis_code</td>
      <td>900</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="analysis-key-findings">
<a class="anchor" href="#analysis-key-findings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis key findings</h3>

<ul>
  <li>The ndc_code field has a high amount of missing values (23460)</li>
  <li>num_lab_procedures and num_medications seem to have a roughly normal distribution</li>
  <li>Fields that have a high cardinality are - medical_specialty, primary_diagnosis_code, other_diagnosis_codes, ndc_code, and principal_diagnosis_code. This is because there are many thousands of these codes that correspond to the many disease and diagnosis sub-classes that exist in the medical field.</li>
  <li>The distribution for the age field is approximately normal, which we would expect. The distribution for the gender field is roughly uniform &amp; equal. In this case we discount the very small number of Unknown/valid cases. Again this is not surprising, as the distribution of genders in the general population is also roughly equal so this seems to be a representitive sample from the general population.</li>
</ul>

<h2 id="reduce-dimensionality-of-the-ndc-code-feature">
<a class="anchor" href="#reduce-dimensionality-of-the-ndc-code-feature" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reduce Dimensionality of the NDC Code Feature</h2>

<p>NDC codes are a common format to represent the wide variety of drugs that are prescribed for patient care in the United States. The challenge is that there are many codes that map to the same or similar drug. We are provided with the ndc drug lookup file https://github.com/udacity/nd320-c1-emr-data-starter/blob/master/project/data_schema_references/ndc_lookup_table.csv derived from the National Drug Codes List site(https://ndclist.com/).</p>

<p>We can use this file to come up with a way to reduce the dimensionality of this field and create a new field in the dataset called “generic_drug_name” in the output dataframe.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#NDC code lookup file
</span><span class="n">ndc_code_path</span> <span class="o">=</span> <span class="s">"./medication_lookup_tables/final_ndc_lookup_table"</span>
<span class="n">ndc_code_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ndc_code_path</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Check first new rows
</span><span class="n">ndc_code_df</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDC_Code</th>
      <th>Proprietary Name</th>
      <th>Non-proprietary Name</th>
      <th>Dosage Form</th>
      <th>Route Name</th>
      <th>Company Name</th>
      <th>Product Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0087-6060</td>
      <td>Glucophage</td>
      <td>Metformin Hydrochloride</td>
      <td>Tablet, Film Coated</td>
      <td>Oral</td>
      <td>Bristol-myers Squibb Company</td>
      <td>Human Prescription Drug</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0087-6063</td>
      <td>Glucophage XR</td>
      <td>Metformin Hydrochloride</td>
      <td>Tablet, Extended Release</td>
      <td>Oral</td>
      <td>Bristol-myers Squibb Company</td>
      <td>Human Prescription Drug</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0087-6064</td>
      <td>Glucophage XR</td>
      <td>Metformin Hydrochloride</td>
      <td>Tablet, Extended Release</td>
      <td>Oral</td>
      <td>Bristol-myers Squibb Company</td>
      <td>Human Prescription Drug</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0087-6070</td>
      <td>Glucophage</td>
      <td>Metformin Hydrochloride</td>
      <td>Tablet, Film Coated</td>
      <td>Oral</td>
      <td>Bristol-myers Squibb Company</td>
      <td>Human Prescription Drug</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0087-6071</td>
      <td>Glucophage</td>
      <td>Metformin Hydrochloride</td>
      <td>Tablet, Film Coated</td>
      <td>Oral</td>
      <td>Bristol-myers Squibb Company</td>
      <td>Human Prescription Drug</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Check for duplicate NDC_Code's
</span><span class="n">ndc_code_df</span><span class="p">[</span><span class="n">ndc_code_df</span><span class="p">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">'NDC_Code'</span><span class="p">])]</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDC_Code</th>
      <th>Proprietary Name</th>
      <th>Non-proprietary Name</th>
      <th>Dosage Form</th>
      <th>Route Name</th>
      <th>Company Name</th>
      <th>Product Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>263</th>
      <td>0781-5634</td>
      <td>Pioglitazone Hydrochloride And Glimepiride</td>
      <td>Pioglitazone Hydrochloride And Glimepiride</td>
      <td>Tablet</td>
      <td>Oral</td>
      <td>Sandoz Inc</td>
      <td>Human Prescription Drug</td>
    </tr>
    <tr>
      <th>264</th>
      <td>0781-5635</td>
      <td>Pioglitazone Hydrochloride And Glimepiride</td>
      <td>Pioglitazone Hydrochloride And Glimepiride</td>
      <td>Tablet</td>
      <td>Oral</td>
      <td>Sandoz Inc</td>
      <td>Human Prescription Drug</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Remove duplicates
</span><span class="n">ndc_code_df</span> <span class="o">=</span> <span class="n">ndc_code_df</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ndc_code_df</span><span class="p">.</span><span class="n">index</span><span class="p">[[</span><span class="mi">263</span><span class="p">,</span><span class="mi">264</span><span class="p">]])</span>
<span class="n">ndc_code_df</span><span class="p">[</span><span class="n">ndc_code_df</span><span class="p">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">'NDC_Code'</span><span class="p">])]</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDC_Code</th>
      <th>Proprietary Name</th>
      <th>Non-proprietary Name</th>
      <th>Dosage Form</th>
      <th>Route Name</th>
      <th>Company Name</th>
      <th>Product Type</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>

<h2 id="select-first-encounter-for-each-patient">
<a class="anchor" href="#select-first-encounter-for-each-patient" aria-hidden="true"><span class="octicon octicon-link"></span></a>Select First Encounter for each Patient</h2>

<p>In order to simplify the aggregation of data for the model, we will only select the first encounter for each patient in the dataset. This is to reduce the risk of data leakage of future patient encounters and to reduce complexity of the data transformation and modeling steps. We will assume that sorting in numerical order on the encounter_id provides the time horizon for determining which encounters come before and after another.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">student_utils</span> <span class="kn">import</span> <span class="n">select_first_encounter</span>
<span class="n">first_encounter_df</span> <span class="o">=</span> <span class="n">select_first_encounter</span><span class="p">(</span><span class="n">reduce_dim_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># unique patients in transformed dataset
</span><span class="n">unique_patients</span> <span class="o">=</span> <span class="n">first_encounter_df</span><span class="p">[</span><span class="s">'patient_nbr'</span><span class="p">].</span><span class="n">nunique</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Number of unique patients:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">unique_patients</span><span class="p">))</span>

<span class="c1"># unique encounters in transformed dataset
</span><span class="n">unique_encounters</span> <span class="o">=</span> <span class="n">first_encounter_df</span><span class="p">[</span><span class="s">'encounter_id'</span><span class="p">].</span><span class="n">nunique</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Number of unique encounters:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">unique_encounters</span><span class="p">))</span>

<span class="n">original_unique_patient_number</span> <span class="o">=</span> <span class="n">reduce_dim_df</span><span class="p">[</span><span class="s">'patient_nbr'</span><span class="p">].</span><span class="n">nunique</span><span class="p">()</span>
<span class="c1"># number of unique patients should be equal to the number of unique encounters and patients in the final dataset
</span><span class="k">assert</span> <span class="n">original_unique_patient_number</span> <span class="o">==</span> <span class="n">unique_patients</span>
<span class="k">assert</span> <span class="n">original_unique_patient_number</span> <span class="o">==</span> <span class="n">unique_encounters</span>
</code></pre></div></div>

<ul>
  <li>Number of unique patients:71518</li>
  <li>Number of unique encounters:71518</li>
</ul>

<h2 id="aggregate-dataset-to-right-level-for-modelling">
<a class="anchor" href="#aggregate-dataset-to-right-level-for-modelling" aria-hidden="true"><span class="octicon octicon-link"></span></a>Aggregate Dataset to Right Level for Modelling</h2>

<p>To make it simpler, we are creating dummy columns for each unique generic drug name and adding those are input features to the model.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">exclusion_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">'generic_drug_name'</span><span class="p">]</span>
<span class="n">grouping_field_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">first_encounter_df</span><span class="p">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclusion_list</span><span class="p">]</span>
<span class="n">agg_drug_df</span><span class="p">,</span> <span class="n">ndc_col_list</span> <span class="o">=</span> <span class="n">aggregate_dataset</span><span class="p">(</span><span class="n">first_encounter_df</span><span class="p">,</span> <span class="n">grouping_field_list</span><span class="p">,</span> <span class="s">'generic_drug_name'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">agg_drug_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">agg_drug_df</span><span class="p">[</span><span class="s">'patient_nbr'</span><span class="p">].</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="n">agg_drug_df</span><span class="p">[</span><span class="s">'encounter_id'</span><span class="p">].</span><span class="n">nunique</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="prepare-fields-and-cast-dataset">
<a class="anchor" href="#prepare-fields-and-cast-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prepare Fields and Cast Dataset</h2>

<h3 id="feature-selection">
<a class="anchor" href="#feature-selection" aria-hidden="true"><span class="octicon octicon-link"></span></a>Feature Selection</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Look at counts for payer_code categories
</span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">"payer_code"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">agg_drug_df</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_45_0.png" alt="png"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Look at counts for weight categories
</span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">"weight"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">agg_drug_df</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_46_0.png" alt="png"></p>

<p>From the category counts above, we can see that for payer_code while there are many unknown values i.e. ‘?’, there are still many values for other payer codes, these may prove useful predictors for our target variable. For weight, there are so few unknown ‘?’ codes, that this feature is likely to be not very helpful for predicting our target variable.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Selected features
</span><span class="n">required_demo_col_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">'race'</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">]</span>
<span class="n">student_categorical_col_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s">"change"</span><span class="p">,</span> <span class="s">"readmitted"</span><span class="p">,</span> <span class="s">"payer_code"</span><span class="p">,</span> <span class="s">"medical_specialty"</span><span class="p">,</span> <span class="s">"primary_diagnosis_code"</span><span class="p">,</span> <span class="s">"other_diagnosis_codes"</span><span class="p">,</span> <span class="s">"max_glu_serum"</span><span class="p">,</span> <span class="s">"A1Cresult"</span><span class="p">,</span>  <span class="s">"admission_type_id"</span><span class="p">,</span> <span class="s">"discharge_disposition_id"</span><span class="p">,</span> <span class="s">"admission_source_id"</span><span class="p">]</span> <span class="o">+</span> <span class="n">required_demo_col_list</span> <span class="o">+</span> <span class="n">ndc_col_list</span>
<span class="n">student_numerical_col_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">"number_outpatient"</span><span class="p">,</span> <span class="s">"number_inpatient"</span><span class="p">,</span> <span class="s">"number_emergency"</span><span class="p">,</span> <span class="s">"num_lab_procedures"</span><span class="p">,</span> <span class="s">"number_diagnoses"</span><span class="p">,</span> <span class="s">"num_medications"</span><span class="p">,</span> <span class="s">"num_procedures"</span><span class="p">]</span>
<span class="n">PREDICTOR_FIELD</span> <span class="o">=</span> <span class="s">'time_in_hospital'</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">select_model_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">categorical_col_list</span><span class="p">,</span> <span class="n">numerical_col_list</span><span class="p">,</span> <span class="n">PREDICTOR_FIELD</span><span class="p">,</span> <span class="n">grouping_key</span><span class="o">=</span><span class="s">'patient_nbr'</span><span class="p">):</span>
    <span class="n">selected_col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">grouping_key</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">PREDICTOR_FIELD</span><span class="p">]</span> <span class="o">+</span> <span class="n">categorical_col_list</span> <span class="o">+</span> <span class="n">numerical_col_list</span>   
    <span class="k">return</span> <span class="n">agg_drug_df</span><span class="p">[</span><span class="n">selected_col_list</span><span class="p">]</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">selected_features_df</span> <span class="o">=</span> <span class="n">select_model_features</span><span class="p">(</span><span class="n">agg_drug_df</span><span class="p">,</span> <span class="n">student_categorical_col_list</span><span class="p">,</span> <span class="n">student_numerical_col_list</span><span class="p">,</span>
                                            <span class="n">PREDICTOR_FIELD</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="preprocess-dataset---casting-and-imputing">
<a class="anchor" href="#preprocess-dataset---casting-and-imputing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Preprocess Dataset - Casting and Imputing</h3>

<p>We will cast and impute the dataset before splitting so that we do not have to repeat these steps across the splits in the next step. For imputing, there can be deeper analysis into which features to impute and how to impute but for the sake of time, we are taking a general strategy of imputing zero for only numerical features.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">processed_df</span> <span class="o">=</span> <span class="n">preprocess_df</span><span class="p">(</span><span class="n">selected_features_df</span><span class="p">,</span> <span class="n">student_categorical_col_list</span><span class="p">,</span>
        <span class="n">student_numerical_col_list</span><span class="p">,</span> <span class="n">PREDICTOR_FIELD</span><span class="p">,</span> <span class="n">categorical_impute_value</span><span class="o">=</span><span class="s">'nan'</span><span class="p">,</span> <span class="n">numerical_impute_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="split-dataset-into-train-validation-and-test-partitions">
<a class="anchor" href="#split-dataset-into-train-validation-and-test-partitions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Split Dataset into Train, Validation, and Test Partitions</h2>

<p>In order to prepare the data for being trained and evaluated by a deep learning model, we will split the dataset into three partitions, with the validation partition used for optimizing the model hyperparameters during training. One of the key parts is that we need to be sure that the data does not accidently leak across partitions.</p>

<p>We will split the input dataset into three partitions(train, validation, test) with the following requirements:</p>

<ul>
  <li>Approximately 60%/20%/20%  train/validation/test split</li>
  <li>Randomly sample different patients into each data partition</li>
  <li>We need to take care that a patient’s data is not in more than one partition, so that we can avoid possible data leakage.</li>
  <li>We need to take care the total number of unique patients across the splits is equal to the total number of unique patients in the original dataset</li>
  <li>Total number of rows in original dataset = sum of rows across all three dataset partitions</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">student_utils</span> <span class="kn">import</span> <span class="n">patient_dataset_splitter</span>
<span class="n">d_train</span><span class="p">,</span> <span class="n">d_val</span><span class="p">,</span> <span class="n">d_test</span> <span class="o">=</span> <span class="n">patient_dataset_splitter</span><span class="p">(</span><span class="n">processed_df</span><span class="p">,</span> <span class="s">'patient_nbr'</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Total number of unique patients in train =  32563</li>
  <li>Total number of unique patients in validation =  10854</li>
  <li>Total number of unique patients in test =  10854</li>
  <li>Training partition has a shape =  (32563, 43)</li>
  <li>Validation partition has a shape =  (10854, 43)</li>
  <li>Test partition has a shape =  (10854, 43)</li>
</ul>

<h2 id="demographic-representation-analysis-of-split">
<a class="anchor" href="#demographic-representation-analysis-of-split" aria-hidden="true"><span class="octicon octicon-link"></span></a>Demographic Representation Analysis of Split</h2>

<p>After the split, we should check to see the distribution of key features/groups and make sure that there is representative samples across the partitions.</p>

<h3 id="label-distribution-across-partitions">
<a class="anchor" href="#label-distribution-across-partitions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Label Distribution Across Partitions</h3>

<p>Are the histogram distribution shapes similar across partitions?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">show_group_stats_viz</span><span class="p">(</span><span class="n">processed_df</span><span class="p">,</span> <span class="n">PREDICTOR_FIELD</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_63_1.png" alt="png"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">show_group_stats_viz</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">PREDICTOR_FIELD</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_64_1.png" alt="png"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">show_group_stats_viz</span><span class="p">(</span><span class="n">d_test</span><span class="p">,</span> <span class="n">PREDICTOR_FIELD</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_65_1.png" alt="png"></p>

<h3 id="demographic-group-analysis">
<a class="anchor" href="#demographic-group-analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Demographic Group Analysis</h3>

<p>We should check that our partitions/splits of the dataset are similar in terms of their demographic profiles.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Full dataset before splitting
</span><span class="n">patient_demo_features</span> <span class="o">=</span> <span class="p">[</span><span class="s">'race'</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">,</span> <span class="s">'patient_nbr'</span><span class="p">]</span>
<span class="n">patient_group_analysis_df</span> <span class="o">=</span> <span class="n">processed_df</span><span class="p">[</span><span class="n">patient_demo_features</span><span class="p">].</span><span class="n">groupby</span><span class="p">(</span><span class="s">'patient_nbr'</span><span class="p">).</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">show_group_stats_viz</span><span class="p">(</span><span class="n">patient_group_analysis_df</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_68_1.png" alt="png"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Training partition
</span><span class="n">show_group_stats_viz</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_69_1.png" alt="png"></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Test partition
</span><span class="n">show_group_stats_viz</span><span class="p">(</span><span class="n">d_test</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_70_1.png" alt="png"></p>

<h2 id="convert-dataset-splits-to-tf-dataset">
<a class="anchor" href="#convert-dataset-splits-to-tf-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Convert Dataset Splits to TF Dataset</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Convert dataset from Pandas dataframes to TF dataset
</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">diabetes_train_ds</span> <span class="o">=</span> <span class="n">df_to_dataset</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">PREDICTOR_FIELD</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">diabetes_val_ds</span> <span class="o">=</span> <span class="n">df_to_dataset</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">PREDICTOR_FIELD</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">diabetes_test_ds</span> <span class="o">=</span> <span class="n">df_to_dataset</span><span class="p">(</span><span class="n">d_test</span><span class="p">,</span> <span class="n">PREDICTOR_FIELD</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We use this sample of the dataset to show transformations later
</span><span class="n">diabetes_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">diabetes_train_ds</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">demo</span><span class="p">(</span><span class="n">feature_column</span><span class="p">,</span> <span class="n">example_batch</span><span class="p">):</span>
    <span class="n">feature_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">DenseFeatures</span><span class="p">(</span><span class="n">feature_column</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">feature_layer</span><span class="p">(</span><span class="n">example_batch</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="create-features">
<a class="anchor" href="#create-features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create Features</h2>
<h3 id="create-categorical-features-with-tf-feature-columns">
<a class="anchor" href="#create-categorical-features-with-tf-feature-columns" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create Categorical Features with TF Feature Columns</h3>

<p>Before we can create the TF categorical features, we must first create the vocab files with the unique values for a given field that are from the <strong>training</strong> dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Build Vocabulary for Categorical Features
</span><span class="n">vocab_file_list</span> <span class="o">=</span> <span class="n">build_vocab_files</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">student_categorical_col_list</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="create-categorical-features-with-tensorflow-feature-column-api">
<a class="anchor" href="#create-categorical-features-with-tensorflow-feature-column-api" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create Categorical Features with Tensorflow Feature Column API</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">student_utils</span> <span class="kn">import</span> <span class="n">create_tf_categorical_feature_cols</span>
<span class="n">tf_cat_col_list</span> <span class="o">=</span> <span class="n">create_tf_categorical_feature_cols</span><span class="p">(</span><span class="n">student_categorical_col_list</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_cat_var1</span> <span class="o">=</span> <span class="n">tf_cat_col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Example categorical field:</span><span class="se">\n</span><span class="s">{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">test_cat_var1</span><span class="p">))</span>
<span class="n">demo</span><span class="p">(</span><span class="n">test_cat_var1</span><span class="p">,</span> <span class="n">diabetes_batch</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="create-numerical-features-with-tf-feature-columns">
<a class="anchor" href="#create-numerical-features-with-tf-feature-columns" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create Numerical Features with TF Feature Columns</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">student_utils</span> <span class="kn">import</span> <span class="n">create_tf_numeric_feature</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_stats_from_train_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="n">describe</span><span class="p">()[</span><span class="s">'mean'</span><span class="p">]</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="n">describe</span><span class="p">()[</span><span class="s">'std'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span>

<span class="k">def</span> <span class="nf">create_tf_numerical_feature_cols</span><span class="p">(</span><span class="n">numerical_col_list</span><span class="p">,</span> <span class="n">train_df</span><span class="p">):</span>
    <span class="n">tf_numeric_col_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">numerical_col_list</span><span class="p">:</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">calculate_stats_from_train_data</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">tf_numeric_feature</span> <span class="o">=</span> <span class="n">create_tf_numeric_feature</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
        <span class="n">tf_numeric_col_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf_numeric_feature</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf_numeric_col_list</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tf_cont_col_list</span> <span class="o">=</span> <span class="n">create_tf_numerical_feature_cols</span><span class="p">(</span><span class="n">student_numerical_col_list</span><span class="p">,</span> <span class="n">d_train</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_cont_var1</span> <span class="o">=</span> <span class="n">tf_cont_col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Example continuous field:</span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">test_cont_var1</span><span class="p">))</span>
<span class="n">demo</span><span class="p">(</span><span class="n">test_cont_var1</span><span class="p">,</span> <span class="n">diabetes_batch</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="build-deep-learning-regression-model-with-sequential-api-and-tf-probability-layers">
<a class="anchor" href="#build-deep-learning-regression-model-with-sequential-api-and-tf-probability-layers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build Deep Learning Regression Model with Sequential API and TF Probability Layers</h2>

<h3 id="use-densefeatures-to-combine-features-for-model">
<a class="anchor" href="#use-densefeatures-to-combine-features-for-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Use DenseFeatures to combine features for model</h3>

<p>Now that we have prepared categorical and numerical features using Tensorflow’s Feature Column API, we can combine them into a dense vector representation for the model. Below we will create this new input layer, which we will call ‘claim_feature_layer’.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">claim_feature_columns</span> <span class="o">=</span> <span class="n">tf_cat_col_list</span> <span class="o">+</span> <span class="n">tf_cont_col_list</span>
<span class="n">claim_feature_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">DenseFeatures</span><span class="p">(</span><span class="n">claim_feature_columns</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="build-sequential-api-model-from-densefeatures-and-tf-probability-layers">
<a class="anchor" href="#build-sequential-api-model-from-densefeatures-and-tf-probability-layers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build Sequential API Model from DenseFeatures and TF Probability Layers</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_sequential_model</span><span class="p">(</span><span class="n">feature_layer</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
        <span class="n">feature_layer</span><span class="p">,</span>
        <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
        <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span><span class="c1"># New
</span>        <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
        <span class="n">tfp</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">DenseVariational</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">posterior_mean_field</span><span class="p">,</span> <span class="n">prior_trainable</span><span class="p">),</span>
        <span class="n">tfp</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">DistributionLambda</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span><span class="n">tfp</span><span class="p">.</span><span class="n">distributions</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">t</span><span class="p">[...,</span> <span class="p">:</span><span class="mi">1</span><span class="p">],</span>
                                             <span class="n">scale</span><span class="o">=</span><span class="mf">1e-3</span> <span class="o">+</span> <span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">softplus</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">t</span><span class="p">[...,</span><span class="mi">1</span><span class="p">:])</span>
                                             <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">def</span> <span class="nf">build_diabetes_model</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">,</span>  <span class="n">feature_layer</span><span class="p">,</span>  <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">loss_metric</span><span class="o">=</span><span class="s">'mse'</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">build_sequential_model</span><span class="p">(</span><span class="n">feature_layer</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss_metric</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">loss_metric</span><span class="p">])</span>
    <span class="c1">#model.compile(optimizer='rmsprop', loss=loss_metric, metrics=[loss_metric])
</span>    <span class="c1">#early_stop = tf.keras.callbacks.EarlyStopping(monitor=loss_metric, patience=3)     
</span>    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">val_ds</span><span class="p">,</span>
                        <span class="c1">#callbacks=[early_stop],
</span>                        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">history</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">diabetes_model</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="n">build_diabetes_model</span><span class="p">(</span><span class="n">diabetes_train_ds</span><span class="p">,</span> <span class="n">diabetes_val_ds</span><span class="p">,</span>  <span class="n">claim_feature_layer</span><span class="p">,</span>  <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="show-model-uncertainty-range-with-tf-probability">
<a class="anchor" href="#show-model-uncertainty-range-with-tf-probability" aria-hidden="true"><span class="octicon octicon-link"></span></a>Show Model Uncertainty Range with TF Probability</h3>

<p>Now that we have trained a model with TF Probability layers, we can extract the mean and standard deviation for each prediction.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">feature_list</span> <span class="o">=</span> <span class="n">student_categorical_col_list</span> <span class="o">+</span> <span class="n">student_numerical_col_list</span>
<span class="n">diabetes_x_tst</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d_test</span><span class="p">[</span><span class="n">feature_list</span><span class="p">])</span>
<span class="n">diabetes_yhat</span> <span class="o">=</span> <span class="n">diabetes_model</span><span class="p">(</span><span class="n">diabetes_x_tst</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">diabetes_model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">diabetes_test_ds</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">student_utils</span> <span class="kn">import</span> <span class="n">get_mean_std_from_preds</span>
<span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">get_mean_std_from_preds</span><span class="p">(</span><span class="n">diabetes_yhat</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="show-prediction-output">
<a class="anchor" href="#show-prediction-output" aria-hidden="true"><span class="octicon octicon-link"></span></a>Show Prediction Output</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prob_outputs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"pred"</span><span class="p">:</span> <span class="n">preds</span><span class="p">.</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="s">"actual_value"</span><span class="p">:</span> <span class="n">d_test</span><span class="p">[</span><span class="s">'time_in_hospital'</span><span class="p">].</span><span class="n">values</span><span class="p">,</span>
    <span class="s">"pred_mean"</span><span class="p">:</span> <span class="n">m</span><span class="p">.</span><span class="n">numpy</span><span class="p">().</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="s">"pred_std"</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="n">numpy</span><span class="p">().</span><span class="n">flatten</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">prob_output_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">prob_outputs</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prob_output_df</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pred</th>
      <th>actual_value</th>
      <th>pred_mean</th>
      <th>pred_std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.587955</td>
      <td>3.0</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5.007016</td>
      <td>2.0</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4.809363</td>
      <td>9.0</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5.003417</td>
      <td>2.0</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.346958</td>
      <td>8.0</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prob_output_df</span><span class="p">.</span><span class="n">describe</span><span class="p">()</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pred</th>
      <th>actual_value</th>
      <th>pred_mean</th>
      <th>pred_std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>10854.000000</td>
      <td>10854.000000</td>
      <td>10854.000000</td>
      <td>10854.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>4.376980</td>
      <td>4.429888</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.908507</td>
      <td>3.002044</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.976290</td>
      <td>1.000000</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>3.755292</td>
      <td>2.000000</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>4.382993</td>
      <td>4.000000</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>5.002859</td>
      <td>6.000000</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
    <tr>
      <th>max</th>
      <td>7.529900</td>
      <td>14.000000</td>
      <td>4.673843</td>
      <td>0.693749</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="convert-regression-output-to-classification-output-for-patient-selection">
<a class="anchor" href="#convert-regression-output-to-classification-output-for-patient-selection" aria-hidden="true"><span class="octicon octicon-link"></span></a>Convert Regression Output to Classification Output for Patient Selection</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">student_utils</span> <span class="kn">import</span> <span class="n">get_student_binary_prediction</span>
<span class="n">student_binary_prediction</span> <span class="o">=</span> <span class="n">get_student_binary_prediction</span><span class="p">(</span><span class="n">prob_output_df</span><span class="p">,</span> <span class="s">'pred'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">student_binary_prediction</span><span class="p">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>0:8137</li>
  <li>1:2717</li>
</ul>

<h3 id="add-binary-prediction-to-test-dataframe">
<a class="anchor" href="#add-binary-prediction-to-test-dataframe" aria-hidden="true"><span class="octicon octicon-link"></span></a>Add Binary Prediction to Test Dataframe</h3>

<p>Using the student_binary_prediction output that is a numpy array with binary labels, we can use this to add to a dataframe to better visualize and also to prepare the data for the Aequitas toolkit. The Aequitas toolkit requires that the predictions be mapped to a binary label for the predictions (called ‘score’ field) and the actual value (called ‘label_value’).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">add_pred_to_test</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">pred_np</span><span class="p">,</span> <span class="n">demo_col_list</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">demo_col_list</span><span class="p">:</span>
        <span class="n">test_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">test_df</span><span class="p">[</span><span class="s">'score'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_np</span>
    <span class="n">test_df</span><span class="p">[</span><span class="s">'label_value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'time_in_hospital'</span><span class="p">].</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span><span class="mi">5</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_df</span>

<span class="n">pred_test_df</span> <span class="o">=</span> <span class="n">add_pred_to_test</span><span class="p">(</span><span class="n">d_test</span><span class="p">,</span> <span class="n">student_binary_prediction</span><span class="p">,</span> <span class="p">[</span><span class="s">'race'</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pred_test_df</span><span class="p">[[</span><span class="s">'patient_nbr'</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">,</span> <span class="s">'race'</span><span class="p">,</span> <span class="s">'time_in_hospital'</span><span class="p">,</span> <span class="s">'score'</span><span class="p">,</span> <span class="s">'label_value'</span><span class="p">]].</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patient_nbr</th>
      <th>gender</th>
      <th>race</th>
      <th>time_in_hospital</th>
      <th>score</th>
      <th>label_value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>122896787</td>
      <td>Male</td>
      <td>Caucasian</td>
      <td>3.0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>102598929</td>
      <td>Male</td>
      <td>Caucasian</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>80367957</td>
      <td>Male</td>
      <td>Caucasian</td>
      <td>9.0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6721533</td>
      <td>Male</td>
      <td>Caucasian</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>104346288</td>
      <td>Female</td>
      <td>Caucasian</td>
      <td>8.0</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="model-evaluation-metrics">
<a class="anchor" href="#model-evaluation-metrics" aria-hidden="true"><span class="octicon octicon-link"></span></a>Model Evaluation Metrics</h2>

<p>Now it is time to use the newly created binary labels in the ‘pred_test_df’ dataframe to evaluate the model with some common classification metrics. We will create a report summary of the performance of the model and give the ROC AUC, F1 score(weighted), class precision and recall scores.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># AUC, F1, precision and recall
# Summary
</span><span class="n">y_true</span> <span class="o">=</span> <span class="n">pred_test_df</span><span class="p">[</span><span class="s">'label_value'</span><span class="p">].</span><span class="n">values</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">pred_test_df</span><span class="p">[</span><span class="s">'score'</span><span class="p">].</span><span class="n">values</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>0.5627418463239359</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>0.5032089104088319</li>
</ul>

<p>Precision-recall tradeoff - The model has been optimised to identify those patients correct for the trial with the fewest mistakes, while also trying to ensure we identify as many of them as possible.</p>

<p>Areas of imporovement - we could look to engineer new features that might help us better predict our target patients.</p>

<h2 id="evaluating-potential-model-biases-with-aequitas-toolkit">
<a class="anchor" href="#evaluating-potential-model-biases-with-aequitas-toolkit" aria-hidden="true"><span class="octicon octicon-link"></span></a>Evaluating Potential Model Biases with Aequitas Toolkit</h2>

<h3 id="prepare-data-for-aequitas-bias-toolkit">
<a class="anchor" href="#prepare-data-for-aequitas-bias-toolkit" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prepare Data For Aequitas Bias Toolkit</h3>

<p>Using the gender and race fields, we will prepare the data for the Aequitas Toolkit.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Aequitas
</span><span class="kn">from</span> <span class="nn">aequitas.preprocessing</span> <span class="kn">import</span> <span class="n">preprocess_input_df</span>
<span class="kn">from</span> <span class="nn">aequitas.group</span> <span class="kn">import</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">aequitas.plotting</span> <span class="kn">import</span> <span class="n">Plot</span>
<span class="kn">from</span> <span class="nn">aequitas.bias</span> <span class="kn">import</span> <span class="n">Bias</span>
<span class="kn">from</span> <span class="nn">aequitas.fairness</span> <span class="kn">import</span> <span class="n">Fairness</span>

<span class="n">ae_subset_df</span> <span class="o">=</span> <span class="n">pred_test_df</span><span class="p">[[</span><span class="s">'race'</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">,</span> <span class="s">'score'</span><span class="p">,</span> <span class="s">'label_value'</span><span class="p">]]</span>
<span class="n">ae_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">preprocess_input_df</span><span class="p">(</span><span class="n">ae_subset_df</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">Group</span><span class="p">()</span>
<span class="n">xtab</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">get_crosstabs</span><span class="p">(</span><span class="n">ae_df</span><span class="p">)</span>
<span class="n">absolute_metrics</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">list_absolute_metrics</span><span class="p">(</span><span class="n">xtab</span><span class="p">)</span>
<span class="n">clean_xtab</span> <span class="o">=</span> <span class="n">xtab</span><span class="p">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">aqp</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">Bias</span><span class="p">()</span>

</code></pre></div></div>

<ul>
  <li>model_id, score_thresholds 1 {‘rank_abs’: [2717]}</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">absolute_metrics</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">list_absolute_metrics</span><span class="p">(</span><span class="n">xtab</span><span class="p">)</span>
<span class="n">xtab</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">xtab</span><span class="p">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">absolute_metrics</span><span class="p">]]</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_id</th>
      <th>score_threshold</th>
      <th>k</th>
      <th>attribute_name</th>
      <th>attribute_value</th>
      <th>pp</th>
      <th>pn</th>
      <th>fp</th>
      <th>fn</th>
      <th>tn</th>
      <th>tp</th>
      <th>group_label_pos</th>
      <th>group_label_neg</th>
      <th>group_size</th>
      <th>total_entities</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>binary 0/1</td>
      <td>2717</td>
      <td>race</td>
      <td>?</td>
      <td>86</td>
      <td>240</td>
      <td>56</td>
      <td>85</td>
      <td>155</td>
      <td>30</td>
      <td>115</td>
      <td>211</td>
      <td>326</td>
      <td>10854</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>binary 0/1</td>
      <td>2717</td>
      <td>race</td>
      <td>AfricanAmerican</td>
      <td>491</td>
      <td>1530</td>
      <td>291</td>
      <td>592</td>
      <td>938</td>
      <td>200</td>
      <td>792</td>
      <td>1229</td>
      <td>2021</td>
      <td>10854</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>binary 0/1</td>
      <td>2717</td>
      <td>race</td>
      <td>Asian</td>
      <td>15</td>
      <td>60</td>
      <td>10</td>
      <td>16</td>
      <td>44</td>
      <td>5</td>
      <td>21</td>
      <td>54</td>
      <td>75</td>
      <td>10854</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>binary 0/1</td>
      <td>2717</td>
      <td>race</td>
      <td>Caucasian</td>
      <td>2030</td>
      <td>6038</td>
      <td>1249</td>
      <td>2298</td>
      <td>3740</td>
      <td>781</td>
      <td>3079</td>
      <td>4989</td>
      <td>8068</td>
      <td>10854</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>binary 0/1</td>
      <td>2717</td>
      <td>race</td>
      <td>Hispanic</td>
      <td>52</td>
      <td>141</td>
      <td>35</td>
      <td>48</td>
      <td>93</td>
      <td>17</td>
      <td>65</td>
      <td>128</td>
      <td>193</td>
      <td>10854</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>binary 0/1</td>
      <td>2717</td>
      <td>race</td>
      <td>Other</td>
      <td>43</td>
      <td>128</td>
      <td>26</td>
      <td>40</td>
      <td>88</td>
      <td>17</td>
      <td>57</td>
      <td>114</td>
      <td>171</td>
      <td>10854</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>binary 0/1</td>
      <td>2717</td>
      <td>gender</td>
      <td>Female</td>
      <td>1413</td>
      <td>4306</td>
      <td>820</td>
      <td>1675</td>
      <td>2631</td>
      <td>593</td>
      <td>2268</td>
      <td>3451</td>
      <td>5719</td>
      <td>10854</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1</td>
      <td>binary 0/1</td>
      <td>2717</td>
      <td>gender</td>
      <td>Male</td>
      <td>1304</td>
      <td>3831</td>
      <td>847</td>
      <td>1404</td>
      <td>2427</td>
      <td>457</td>
      <td>1861</td>
      <td>3274</td>
      <td>5135</td>
      <td>10854</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="reference-group-selection">
<a class="anchor" href="#reference-group-selection" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reference Group Selection</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Test reference group with Caucasian Male
</span><span class="n">bdf</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">get_disparity_predefined_groups</span><span class="p">(</span><span class="n">clean_xtab</span><span class="p">,</span>
                    <span class="n">original_df</span><span class="o">=</span><span class="n">ae_df</span><span class="p">,</span>
                    <span class="n">ref_groups_dict</span><span class="o">=</span><span class="p">{</span><span class="s">'race'</span><span class="p">:</span><span class="s">'Caucasian'</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">:</span><span class="s">'Male'</span>
                                     <span class="p">},</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                    <span class="n">check_significance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="n">f</span> <span class="o">=</span> <span class="n">Fairness</span><span class="p">()</span>
<span class="n">fdf</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">get_group_value_fairness</span><span class="p">(</span><span class="n">bdf</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="race-and-gender-bias-analysis-for-patient-selection">
<a class="anchor" href="#race-and-gender-bias-analysis-for-patient-selection" aria-hidden="true"><span class="octicon octicon-link"></span></a>Race and Gender Bias Analysis for Patient Selection</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot two metrics
# Is there significant bias in your model for either race or gender?
</span><span class="n">fpr_disparity1</span> <span class="o">=</span> <span class="n">aqp</span><span class="p">.</span><span class="n">plot_disparity</span><span class="p">(</span><span class="n">bdf</span><span class="p">,</span> <span class="n">group_metric</span><span class="o">=</span><span class="s">'fpr_disparity'</span><span class="p">,</span> <span class="n">attribute_name</span><span class="o">=</span><span class="s">'race'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_122_0.png" alt="png"></p>

<p>We notice that while with most races, there is no significant indication of bias, there is an indication that Asians are less likely to be itentified by the model, based on the 0.4 disparity in relation to the Caucasian reference group.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fpr_disparity2</span> <span class="o">=</span> <span class="n">aqp</span><span class="p">.</span><span class="n">plot_disparity</span><span class="p">(</span><span class="n">bdf</span><span class="p">,</span> <span class="n">group_metric</span><span class="o">=</span><span class="s">'fpr_disparity'</span><span class="p">,</span> <span class="n">attribute_name</span><span class="o">=</span><span class="s">'gender'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_124_0.png" alt="png"></p>

<p>With gender, there does not seem to be any significant indication of bias.</p>

<h3 id="fairness-analysis-example---relative-to-a-reference-group">
<a class="anchor" href="#fairness-analysis-example---relative-to-a-reference-group" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fairness Analysis Example - Relative to a Reference Group</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Reference group fairness plot
</span><span class="n">fpr_fairness</span> <span class="o">=</span> <span class="n">aqp</span><span class="p">.</span><span class="n">plot_fairness_group</span><span class="p">(</span><span class="n">fdf</span><span class="p">,</span> <span class="n">group_metric</span><span class="o">=</span><span class="s">'fpr'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_127_0.png" alt="png"></p>

<p>Here again we can see that there appears to be signficant disparity with the Asian race being under-represented with a magnitude of 0.19.</p>

  </div>
  
  <a class="u-url" href="/health/deep-learning/electronic-health-records/2022/02/06/patient-select-diabetes.html" hidden></a>
</article><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="pranath/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/pranath" target="_blank" title="pranath"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/pranath-fernando" target="_blank" title="pranath-fernando"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/livingdatalab" target="_blank" title="livingdatalab"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
<script type="text/javascript" src="/js/lightbox.js"></script>
<link rel="stylesheet" href="/css/lightbox.css">
</body>

</html>
