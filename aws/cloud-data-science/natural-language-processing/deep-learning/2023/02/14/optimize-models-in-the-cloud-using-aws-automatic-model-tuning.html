<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Optimize Models in the Cloud using AWS Automatic Model Tuning</h1><p class="page-description">When training ML models, hyperparameter tuning is a step taken to find the best performing training model. In this article we will apply a random algorithm of Automated Hyperparameter Tuning to train a BERT-based natural language processing (NLP) classifier. The model analyzes customer feedback and classifies the messages into positive, neutral, and negative sentiments.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2023-02-14T00:00:00-06:00" itemprop="datePublished">
        Feb 14, 2023
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      13 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#aws">aws</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#cloud-data-science">cloud-data-science</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#natural-language-processing">natural-language-processing</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#deep-learning">deep-learning</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Introduction">Introduction </a></li>
<li class="toc-entry toc-h2"><a href="#Configure-dataset-and-Hyperparameter-Tuning-Job-(HTP)">Configure dataset and Hyperparameter Tuning Job (HTP) </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Configure-dataset">Configure dataset </a></li>
<li class="toc-entry toc-h3"><a href="#Configure-Hyperparameter-Tuning-Job">Configure Hyperparameter Tuning Job </a></li>
<li class="toc-entry toc-h3"><a href="#Set-up-evaluation-metrics">Set up evaluation metrics </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Run-Tuning-Job">Run Tuning Job </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Set-up-the-RoBERTa-and-PyTorch-script-to-run-on-SageMaker">Set up the RoBERTa and PyTorch script to run on SageMaker </a></li>
<li class="toc-entry toc-h3"><a href="#Launch-the-Hyperparameter-Tuning-Job">Launch the Hyperparameter Tuning Job </a></li>
<li class="toc-entry toc-h3"><a href="#Check-Tuning-Job-status">Check Tuning Job status </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Evaluate-the-results">Evaluate the results </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Show-the-best-candidate">Show the best candidate </a></li>
<li class="toc-entry toc-h3"><a href="#Evaluate-the-best-candidate">Evaluate the best candidate </a></li>
<li class="toc-entry toc-h3"><a href="#Inspect-the-processed-output-data">Inspect the processed output data </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Acknowledgements">Acknowledgements </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2023-02-14-optimize-models-in-the-cloud-using-aws-automatic-model-tuning.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h2>
<p>In <a href="https://livingdatalab.com/categories/#aws">earlier articles we introduced AWS cloud services for data science</a>, and showed how it can help with different stages of the data science &amp; machine learning workflow.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/aws_ds_workflow.png" alt="" title="The AWS Data Science Workflow"></p>
<p>When training ML models, hyperparameter tuning is a step taken to find the best performing training model. In this project we will apply a random algorithm of Automated Hyperparameter Tuning to train a BERT-based natural language processing (NLP) classifier.</p>
<p>We will use the raw <a href="https://www.kaggle.com/nicapotato/womens-ecommerce-clothing-reviews">Women's Clothing Reviews</a> dataset - and will prepare it to train a deep learning BERT-based natural language processing (NLP) model. The model will be used to classify customer reviews into positive (1), neutral (0) and negative (-1) sentiment.</p>
<p>Amazon SageMaker supports Automated Hyperparameter Tuning. It runs multiple training jobs on the training dataset using the hyperparameter ranges specified by the user. Then it chooses the combination of hyperparameters that leads to the best model candidate. The choice is made based on the objective metrics, e.g. maximization of the validation accuracy.</p>
<p>For the choice of hyperparameters combinations, SageMaker supports two different types of tuning strategies: random and Bayesian. This capability can be further extended by providing an implementation of a custom tuning strategy as a Docker container.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://github.com/pranath/blog/raw/master/images/hpt.png" alt="" title="Hyperparameter Tuning"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this project we will perform the following three steps:</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/sagemaker_hpt.png" alt="" title="Hyperparameter Tuning with AWS"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First, let's install and import the required modules.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">sagemaker</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">botocore</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">botocore</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="n">user_agent_extra</span><span class="o">=</span><span class="s1">'dlai-pds/c3/w1'</span><span class="p">)</span>

<span class="c1"># low-level service client of the boto3 session</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">service_name</span><span class="o">=</span><span class="s1">'sagemaker'</span><span class="p">,</span> 
                  <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">sagemaker_client</span><span class="o">=</span><span class="n">sm</span><span class="p">)</span>

<span class="n">bucket</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">default_bucket</span><span class="p">()</span>
<span class="n">role</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">get_execution_role</span><span class="p">()</span>
<span class="n">region</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">boto_region_name</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Configure-dataset-and-Hyperparameter-Tuning-Job-(HTP)">
<a class="anchor" href="#Configure-dataset-and-Hyperparameter-Tuning-Job-(HTP)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure dataset and Hyperparameter Tuning Job (HTP)<a class="anchor-link" href="#Configure-dataset-and-Hyperparameter-Tuning-Job-(HTP)"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configure-dataset">
<a class="anchor" href="#Configure-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure dataset<a class="anchor-link" href="#Configure-dataset"> </a>
</h3>
<p>Let's set up the paths and copy the data to the S3 bucket:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">processed_train_data_s3_uri</span> <span class="o">=</span> <span class="s1">'s3://</span><span class="si">{}</span><span class="s1">/transformed/data/sentiment-train/'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
<span class="n">processed_validation_data_s3_uri</span> <span class="o">=</span> <span class="s1">'s3://</span><span class="si">{}</span><span class="s1">/transformed/data/sentiment-validation/'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
<span class="n">processed_test_data_s3_uri</span> <span class="o">=</span> <span class="s1">'s3://</span><span class="si">{}</span><span class="s1">/transformed/data/sentiment-test/'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Upload the data to the S3 bucket:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>aws s3 cp --recursive ./data/sentiment-train <span class="nv">$processed_train_data_s3_uri</span>
<span class="o">!</span>aws s3 cp --recursive ./data/sentiment-validation <span class="nv">$processed_validation_data_s3_uri</span>
<span class="o">!</span>aws s3 cp --recursive ./data/sentiment-test <span class="nv">$processed_test_data_s3_uri</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>upload: data/sentiment-train/part-algo-1-womens_clothing_ecommerce_reviews.tsv to s3://sagemaker-us-east-1-058323655887/transformed/data/sentiment-train/part-algo-1-womens_clothing_ecommerce_reviews.tsv
upload: data/sentiment-validation/part-algo-1-womens_clothing_ecommerce_reviews.tsv to s3://sagemaker-us-east-1-058323655887/transformed/data/sentiment-validation/part-algo-1-womens_clothing_ecommerce_reviews.tsv
upload: data/sentiment-test/part-algo-1-womens_clothing_ecommerce_reviews.tsv to s3://sagemaker-us-east-1-058323655887/transformed/data/sentiment-test/part-algo-1-womens_clothing_ecommerce_reviews.tsv
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Check the existence of those files in the S3 bucket:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>aws s3 ls --recursive <span class="nv">$processed_train_data_s3_uri</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2023-02-13 17:36:41    4894416 transformed/data/sentiment-train/part-algo-1-womens_clothing_ecommerce_reviews.tsv
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>aws s3 ls --recursive <span class="nv">$processed_validation_data_s3_uri</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2023-02-13 17:36:42     276522 transformed/data/sentiment-validation/part-algo-1-womens_clothing_ecommerce_reviews.tsv
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>aws s3 ls --recursive <span class="nv">$processed_test_data_s3_uri</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2023-02-13 17:36:43     273414 transformed/data/sentiment-test/part-algo-1-womens_clothing_ecommerce_reviews.tsv
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we set up a dictionary of the input training and validation data channels, wrapping the corresponding S3 locations in a <code>TrainingInput</code> object.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sagemaker.inputs</span> <span class="kn">import</span> <span class="n">TrainingInput</span>

<span class="n">data_channels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'train'</span><span class="p">:</span> <span class="n">processed_train_data_s3_uri</span><span class="p">,</span> 
    <span class="s1">'validation'</span><span class="p">:</span> <span class="n">processed_validation_data_s3_uri</span> 
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There is no need to create a test data channel, as the test data is used later at the evaluation stage and does not need to be wrapped into the <code>sagemaker.inputs.TrainingInput</code> function.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configure-Hyperparameter-Tuning-Job">
<a class="anchor" href="#Configure-Hyperparameter-Tuning-Job" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure Hyperparameter Tuning Job<a class="anchor-link" href="#Configure-Hyperparameter-Tuning-Job"> </a>
</h3>
<p>Model hyperparameters need to be set prior to starting the model training as they control the process of learning. Some of the hyperparameters you will set up as static - they will not be explored during the tuning job. For the non-static hyperparameters we will set the range of possible values to be explored.</p>
<p>First, we configure static hyperparameters including the instance type, instance count, maximum sequence length, etc. For the purposes of this project, we will use a relatively small instance type. Please refer to <a href="https://aws.amazon.com/sagemaker/pricing/">this link</a> for additional instance types that may work for your use cases.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span> <span class="c1"># maximum number of input tokens passed to BERT model</span>
<span class="n">freeze_bert_layer</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># specifies the depth of training within the network</span>
<span class="n">epochs</span><span class="o">=</span><span class="mi">3</span>
<span class="n">train_steps_per_epoch</span><span class="o">=</span><span class="mi">50</span>
<span class="n">validation_batch_size</span><span class="o">=</span><span class="mi">64</span>
<span class="n">validation_steps_per_epoch</span><span class="o">=</span><span class="mi">50</span>
<span class="n">seed</span><span class="o">=</span><span class="mi">42</span>

<span class="n">train_instance_count</span><span class="o">=</span><span class="mi">1</span>
<span class="n">train_instance_type</span><span class="o">=</span><span class="s1">'ml.c5.9xlarge'</span>
<span class="n">train_volume_size</span><span class="o">=</span><span class="mi">256</span>
<span class="n">input_mode</span><span class="o">=</span><span class="s1">'File'</span>
<span class="n">run_validation</span><span class="o">=</span><span class="kc">True</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some of these will be passed into the PyTorch estimator and tuner in the hyperparameters argument. Let's set up the dictionary for that:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hyperparameters_static</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">'freeze_bert_layer'</span><span class="p">:</span> <span class="n">freeze_bert_layer</span><span class="p">,</span>
    <span class="s1">'max_seq_length'</span><span class="p">:</span> <span class="n">max_seq_length</span><span class="p">,</span>
    <span class="s1">'epochs'</span><span class="p">:</span> <span class="n">epochs</span><span class="p">,</span>
    <span class="s1">'train_steps_per_epoch'</span><span class="p">:</span> <span class="n">train_steps_per_epoch</span><span class="p">,</span>
    <span class="s1">'validation_batch_size'</span><span class="p">:</span> <span class="n">validation_batch_size</span><span class="p">,</span>
    <span class="s1">'validation_steps_per_epoch'</span><span class="p">:</span> <span class="n">validation_steps_per_epoch</span><span class="p">,</span>
    <span class="s1">'seed'</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span>
    <span class="s1">'run_validation'</span><span class="p">:</span> <span class="n">run_validation</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we configure hyperparameter ranges to explore in the Tuning Job. The values of the ranges typically come from prior experience, research papers, or other models similar to the task you are trying to do.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sagemaker.tuner</span> <span class="kn">import</span> <span class="n">IntegerParameter</span>
<span class="kn">from</span> <span class="nn">sagemaker.tuner</span> <span class="kn">import</span> <span class="n">ContinuousParameter</span>
<span class="kn">from</span> <span class="nn">sagemaker.tuner</span> <span class="kn">import</span> <span class="n">CategoricalParameter</span>
                                                
<span class="n">hyperparameter_ranges</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'learning_rate'</span><span class="p">:</span> <span class="n">ContinuousParameter</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.00005</span><span class="p">,</span> <span class="n">scaling_type</span><span class="o">=</span><span class="s1">'Linear'</span><span class="p">),</span> <span class="c1"># specifying continuous variable type, the tuning job will explore the range of values</span>
    <span class="s1">'train_batch_size'</span><span class="p">:</span> <span class="n">CategoricalParameter</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">]),</span> <span class="c1"># specifying categorical variable type, the tuning job will explore only listed values</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Set-up-evaluation-metrics">
<a class="anchor" href="#Set-up-evaluation-metrics" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set up evaluation metrics<a class="anchor-link" href="#Set-up-evaluation-metrics"> </a>
</h3>
<p>Choose loss and accuracy as the evaluation metrics. The regular expressions <code>Regex</code> will capture the values of metrics that the algorithm will emit.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metric_definitions</span> <span class="o">=</span> <span class="p">[</span>
     <span class="p">{</span><span class="s1">'Name'</span><span class="p">:</span> <span class="s1">'validation:loss'</span><span class="p">,</span> <span class="s1">'Regex'</span><span class="p">:</span> <span class="s1">'val_loss: ([0-9.]+)'</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">'Name'</span><span class="p">:</span> <span class="s1">'validation:accuracy'</span><span class="p">,</span> <span class="s1">'Regex'</span><span class="p">:</span> <span class="s1">'val_acc: ([0-9.]+)'</span><span class="p">},</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the Tuning Job, we will be maximizing validation accuracy as the objective metric.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Run-Tuning-Job">
<a class="anchor" href="#Run-Tuning-Job" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run Tuning Job<a class="anchor-link" href="#Run-Tuning-Job"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Set-up-the-RoBERTa-and-PyTorch-script-to-run-on-SageMaker">
<a class="anchor" href="#Set-up-the-RoBERTa-and-PyTorch-script-to-run-on-SageMaker" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set up the RoBERTa and PyTorch script to run on SageMaker<a class="anchor-link" href="#Set-up-the-RoBERTa-and-PyTorch-script-to-run-on-SageMaker"> </a>
</h3>
<p>We will now prepare the PyTorch model to run as a SageMaker Training Job. The estimator takes into the entry point a separate Python file, which will be called during the training. We can open and review this file <a href="https://pranath.github.io/pds/tuning/train.py">src/train.py</a>.</p>
<p>For more information on the <code>PyTorchEstimator</code>, see the documentation here: <a href="https://sagemaker.readthedocs.io/">https://sagemaker.readthedocs.io/</a></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sagemaker.pytorch</span> <span class="kn">import</span> <span class="n">PyTorch</span> <span class="k">as</span> <span class="n">PyTorchEstimator</span>
<span class="c1"># Note: we don't have to rename the PyTorch estimator,</span>
<span class="c1"># but this is useful for code clarity, especially when a few modules of 'sagemaker.pytorch' are used</span>

<span class="n">estimator</span> <span class="o">=</span> <span class="n">PyTorchEstimator</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="s1">'train.py'</span><span class="p">,</span>
    <span class="n">source_dir</span><span class="o">=</span><span class="s1">'src'</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="n">train_instance_count</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="n">train_instance_type</span><span class="p">,</span>
    <span class="n">volume_size</span><span class="o">=</span><span class="n">train_volume_size</span><span class="p">,</span>
    <span class="n">py_version</span><span class="o">=</span><span class="s1">'py3'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s1">'1.6.0'</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="n">hyperparameters_static</span><span class="p">,</span>
    <span class="n">metric_definitions</span><span class="o">=</span><span class="n">metric_definitions</span><span class="p">,</span>
    <span class="n">input_mode</span><span class="o">=</span><span class="n">input_mode</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Launch-the-Hyperparameter-Tuning-Job">
<a class="anchor" href="#Launch-the-Hyperparameter-Tuning-Job" aria-hidden="true"><span class="octicon octicon-link"></span></a>Launch the Hyperparameter Tuning Job<a class="anchor-link" href="#Launch-the-Hyperparameter-Tuning-Job"> </a>
</h3>
<p>A hyperparameter tuning job runs a series of training jobs that each test a combination of hyperparameters for a given objective metric (i.e. <code>validation:accuracy</code>). In this project, we will use a <code>Random</code> search strategy to determine the combinations of hyperparameters - within the specific ranges - to use for each training job within the tuning job.  For more information on hyperparameter tuning search strategies, please see the following documentation:  <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/automatic-model-tuning-how-it-works.html">https://docs.aws.amazon.com/sagemaker/latest/dg/automatic-model-tuning-how-it-works.html</a></p>
<p>When the tuning job completes, we can select the hyperparameters used by the best-performing training job relative to the objective metric.</p>
<p>The <code>max_jobs</code> parameter is a stop criteria that limits the number of overall training jobs (and therefore hyperparameter combinations) to run within the tuning job.</p>
<p>The <code>max_parallel_jobs</code> parameter limits the number of training jobs (and therefore hyperparameter combinations) to run in parallel within the tuning job.  This parameter is often used in combination with the <code>Bayesian</code> search strategy when you want to test a smaller set of training jobs (less than the <code>max_jobs</code>), learn from the smaller set of training jobs, then apply Bayesian methods to determine the next set of hyperparameters used by the next set of training jobs. Bayesian methods can improve hyperparameter-tuning performance in some cases.</p>
<p>The <code>early_stopping_type</code> parameter is used by SageMaker hyper-parameter tuning jobs to automatically stop a training job if the job is not improving the objective metrics (i.e. <code>validation:accuracy</code>) relative to previous training jobs within the tuning job.  For more information on early stopping, please see the following documentation:  <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/automatic-model-tuning-early-stopping.html">https://docs.aws.amazon.com/sagemaker/latest/dg/automatic-model-tuning-early-stopping.html</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's set up the Hyperparameter Tuner.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sagemaker.tuner</span> <span class="kn">import</span> <span class="n">HyperparameterTuner</span>

<span class="n">tuner</span> <span class="o">=</span> <span class="n">HyperparameterTuner</span><span class="p">(</span>
    <span class="n">estimator</span><span class="o">=</span><span class="n">estimator</span><span class="p">,</span> 
    <span class="n">hyperparameter_ranges</span><span class="o">=</span><span class="n">hyperparameter_ranges</span><span class="p">,</span> 
    <span class="n">metric_definitions</span><span class="o">=</span><span class="n">metric_definitions</span><span class="p">,</span> 
    <span class="n">strategy</span><span class="o">=</span><span class="s1">'Random'</span><span class="p">,</span> 
    <span class="n">objective_type</span><span class="o">=</span><span class="s1">'Maximize'</span><span class="p">,</span>
    <span class="n">objective_metric_name</span><span class="o">=</span><span class="s1">'validation:accuracy'</span><span class="p">,</span>
    <span class="n">max_jobs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># maximum number of jobs to run</span>
    <span class="n">max_parallel_jobs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># maximum number of jobs to run in parallel</span>
    <span class="n">early_stopping_type</span><span class="o">=</span><span class="s1">'Auto'</span> <span class="c1"># early stopping criteria</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we launch the SageMaker Hyper-Parameter Tuning (HPT) Job.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="n">data_channels</span><span class="p">,</span> 
    <span class="n">include_cls_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">wait</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Check-Tuning-Job-status">
<a class="anchor" href="#Check-Tuning-Job-status" aria-hidden="true"><span class="octicon octicon-link"></span></a>Check Tuning Job status<a class="anchor-link" href="#Check-Tuning-Job-status"> </a>
</h3>
<p>We can see the Tuning Job status in the console.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuning_job_name</span> <span class="o">=</span> <span class="n">tuner</span><span class="o">.</span><span class="n">latest_tuning_job</span><span class="o">.</span><span class="n">job_name</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tuning_job_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>pytorch-training-230213-1736
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>

<span class="n">tuner</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>.....................................................................................................................................................................................................................................................................................................!
CPU times: user 1.37 s, sys: 191 ms, total: 1.56 s
Wall time: 24min 53s
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The results of the SageMaker Hyperparameter Tuning Job are available on the <code>analytics</code> of the <code>tuner object</code>. The <code>dataframe</code> function converts the result directly into the dataframe. We can explore the results with the following lines of the code:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># slight delay to allow the analytics to be calculated</span>

<span class="n">df_results</span> <span class="o">=</span> <span class="n">tuner</span><span class="o">.</span><span class="n">analytics</span><span class="p">()</span><span class="o">.</span><span class="n">dataframe</span><span class="p">()</span>
<span class="n">df_results</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, 8)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'FinalObjectiveValue'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>learning_rate</th>
      <th>train_batch_size</th>
      <th>TrainingJobName</th>
      <th>TrainingJobStatus</th>
      <th>FinalObjectiveValue</th>
      <th>TrainingStartTime</th>
      <th>TrainingEndTime</th>
      <th>TrainingElapsedTimeSeconds</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000020</td>
      <td>"128"</td>
      <td>pytorch-training-230213-1736-002-23e15b91</td>
      <td>Completed</td>
      <td>73.050003</td>
      <td>2023-02-13 17:38:06+00:00</td>
      <td>2023-02-13 18:01:09+00:00</td>
      <td>1383.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.000017</td>
      <td>"128"</td>
      <td>pytorch-training-230213-1736-001-44bd7477</td>
      <td>Completed</td>
      <td>72.269997</td>
      <td>2023-02-13 17:38:02+00:00</td>
      <td>2023-02-13 18:01:24+00:00</td>
      <td>1402.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When training and tuning at scale, it is important to continuously monitor and use the right compute resources. While we have the flexibility of choosing different compute options how do you choose the specific instance types and sizes to use? There is no standard answer for this. It comes down to understanding the workload and running empirical testing to determine the best compute resources to use for the training.</p>
<p>SageMaker Training Jobs emit CloudWatch metrics for resource utilization. We can review them in the AWS console.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Evaluate-the-results">
<a class="anchor" href="#Evaluate-the-results" aria-hidden="true"><span class="octicon octicon-link"></span></a>Evaluate the results<a class="anchor-link" href="#Evaluate-the-results"> </a>
</h2>
<p>An important part of developing a model is evaluating the model with a test data set - one that the model has never seen during its training process. The final metrics resulting from this evaluation can be used to compare competing machine learning models. The higher the value of these metrics, the better the model is able to generalize.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Show-the-best-candidate">
<a class="anchor" href="#Show-the-best-candidate" aria-hidden="true"><span class="octicon octicon-link"></span></a>Show the best candidate<a class="anchor-link" href="#Show-the-best-candidate"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's now show the best candidate - the one with the highest accuracy result.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="s1">'FinalObjectiveValue'</span><span class="p">,</span> 
    <span class="n">ascending</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>learning_rate</th>
      <th>train_batch_size</th>
      <th>TrainingJobName</th>
      <th>TrainingJobStatus</th>
      <th>FinalObjectiveValue</th>
      <th>TrainingStartTime</th>
      <th>TrainingEndTime</th>
      <th>TrainingElapsedTimeSeconds</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.00002</td>
      <td>"128"</td>
      <td>pytorch-training-230213-1736-002-23e15b91</td>
      <td>Completed</td>
      <td>73.050003</td>
      <td>2023-02-13 17:38:06+00:00</td>
      <td>2023-02-13 18:01:09+00:00</td>
      <td>1383.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Evaluate-the-best-candidate">
<a class="anchor" href="#Evaluate-the-best-candidate" aria-hidden="true"><span class="octicon octicon-link"></span></a>Evaluate the best candidate<a class="anchor-link" href="#Evaluate-the-best-candidate"> </a>
</h3>
<p>Let's pull the information about the best candidate from the dataframe and then take the Training Job name from the column <code>TrainingJobName</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">best_candidate</span> <span class="o">=</span> <span class="n">df_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'FinalObjectiveValue'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">best_candidate_training_job_name</span> <span class="o">=</span> <span class="n">best_candidate</span><span class="p">[</span><span class="s1">'TrainingJobName'</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Best candidate Training Job name: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_candidate_training_job_name</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best candidate Training Job name: pytorch-training-230213-1736-002-23e15b91
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now lets show the accuracy result for the best candidate.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">best_candidate_accuracy</span> <span class="o">=</span> <span class="n">best_candidate</span><span class="p">[</span><span class="s1">'FinalObjectiveValue'</span><span class="p">]</span> 

<span class="nb">print</span><span class="p">(</span><span class="s1">'Best candidate accuracy result: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_candidate_accuracy</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best candidate accuracy result: 73.05000305175781
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can use the function <code>describe_training_job</code> of the service client to get some more information about the best candidate. The result is in dictionary format. Let's check that it has the same Training Job name:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">best_candidate_description</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">describe_training_job</span><span class="p">(</span><span class="n">TrainingJobName</span><span class="o">=</span><span class="n">best_candidate_training_job_name</span><span class="p">)</span>

<span class="n">best_candidate_training_job_name2</span> <span class="o">=</span> <span class="n">best_candidate_description</span><span class="p">[</span><span class="s1">'TrainingJobName'</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'Training Job name: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_candidate_training_job_name2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Training Job name: pytorch-training-230213-1736-002-23e15b91
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now lets pull the Tuning Job and Training Job Amazon Resource Name (ARN) from the best candidate training job description.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">best_candidate_description</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>dict_keys(['TrainingJobName', 'TrainingJobArn', 'TuningJobArn', 'ModelArtifacts', 'TrainingJobStatus', 'SecondaryStatus', 'HyperParameters', 'AlgorithmSpecification', 'RoleArn', 'InputDataConfig', 'OutputDataConfig', 'ResourceConfig', 'StoppingCondition', 'CreationTime', 'TrainingStartTime', 'TrainingEndTime', 'LastModifiedTime', 'SecondaryStatusTransitions', 'FinalMetricDataList', 'EnableNetworkIsolation', 'EnableInterContainerTrafficEncryption', 'EnableManagedSpotTraining', 'TrainingTimeInSeconds', 'BillableTimeInSeconds', 'ProfilingStatus', 'WarmPoolStatus', 'ResponseMetadata'])
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">best_candidate_tuning_job_arn</span> <span class="o">=</span> <span class="n">best_candidate_description</span><span class="p">[</span><span class="s1">'TuningJobArn'</span><span class="p">]</span> 
<span class="n">best_candidate_training_job_arn</span> <span class="o">=</span> <span class="n">best_candidate_description</span><span class="p">[</span><span class="s1">'TrainingJobArn'</span><span class="p">]</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">'Best candidate Tuning Job ARN: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_candidate_tuning_job_arn</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Best candidate Training Job ARN: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_candidate_training_job_arn</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best candidate Tuning Job ARN: arn:aws:sagemaker:us-east-1:058323655887:hyper-parameter-tuning-job/pytorch-training-230213-1736
Best candidate Training Job ARN: arn:aws:sagemaker:us-east-1:058323655887:training-job/pytorch-training-230213-1736-002-23e15b91
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we pull the path of the best candidate model in the S3 bucket. We will need it later to set up the Processing Job for the evaluation.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_tar_s3_uri</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">describe_training_job</span><span class="p">(</span><span class="n">TrainingJobName</span><span class="o">=</span><span class="n">best_candidate_training_job_name</span><span class="p">)[</span><span class="s1">'ModelArtifacts'</span><span class="p">][</span><span class="s1">'S3ModelArtifacts'</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model_tar_s3_uri</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>s3://sagemaker-us-east-1-058323655887/pytorch-training-230213-1736-002-23e15b91/output/model.tar.gz
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To perform model evaluation we will use a scikit-learn-based Processing Job. This is essentially a generic Python Processing Job with scikit-learn pre-installed. We can specify the version of scikit-learn we wish to use. Also we need to pass the SageMaker execution role, processing instance type and instance count.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sagemaker.sklearn.processing</span> <span class="kn">import</span> <span class="n">SKLearnProcessor</span>

<span class="n">processing_instance_type</span> <span class="o">=</span> <span class="s2">"ml.c5.2xlarge"</span>
<span class="n">processing_instance_count</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">processor</span> <span class="o">=</span> <span class="n">SKLearnProcessor</span><span class="p">(</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"0.23-1"</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="n">processing_instance_type</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="n">processing_instance_count</span><span class="p">,</span>
    <span class="n">max_runtime_in_seconds</span><span class="o">=</span><span class="mi">7200</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The model evaluation Processing Job will be running the Python code from the file <a href="https://pranath.github.io/pds/tuning/evaluate_model_metrics.py">src/evaluate_model_metrics.py</a>. You can open and review the file.</p>
<p>Let's launch the Processing Job, passing the defined above parameters, custom script, path and the S3 bucket location of the test data.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sagemaker.processing</span> <span class="kn">import</span> <span class="n">ProcessingInput</span><span class="p">,</span> <span class="n">ProcessingOutput</span>

<span class="n">processor</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">code</span><span class="o">=</span><span class="s2">"src/evaluate_model_metrics.py"</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ProcessingInput</span><span class="p">(</span>  
            <span class="n">input_name</span><span class="o">=</span><span class="s2">"model-tar-s3-uri"</span><span class="p">,</span>                        
            <span class="n">source</span><span class="o">=</span><span class="n">model_tar_s3_uri</span><span class="p">,</span>                               
            <span class="n">destination</span><span class="o">=</span><span class="s2">"/opt/ml/processing/input/model/"</span>
        <span class="p">),</span>
        <span class="n">ProcessingInput</span><span class="p">(</span>
            <span class="n">input_name</span><span class="o">=</span><span class="s2">"evaluation-data-s3-uri"</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">processed_test_data_s3_uri</span><span class="p">,</span>                                    
            <span class="n">destination</span><span class="o">=</span><span class="s2">"/opt/ml/processing/input/data/"</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">],</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ProcessingOutput</span><span class="p">(</span><span class="n">s3_upload_mode</span><span class="o">=</span><span class="s2">"EndOfJob"</span><span class="p">,</span> <span class="n">output_name</span><span class="o">=</span><span class="s2">"metrics"</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">"/opt/ml/processing/output/metrics"</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s2">"--max-seq-length"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_seq_length</span><span class="p">)],</span>
    <span class="n">logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
Job Name:  sagemaker-scikit-learn-2023-02-13-18-04-08-342
Inputs:  [{'InputName': 'model-tar-s3-uri', 'AppManaged': False, 'S3Input': {'S3Uri': 's3://sagemaker-us-east-1-058323655887/pytorch-training-230213-1736-002-23e15b91/output/model.tar.gz', 'LocalPath': '/opt/ml/processing/input/model/', 'S3DataType': 'S3Prefix', 'S3InputMode': 'File', 'S3DataDistributionType': 'FullyReplicated', 'S3CompressionType': 'None'}}, {'InputName': 'evaluation-data-s3-uri', 'AppManaged': False, 'S3Input': {'S3Uri': 's3://sagemaker-us-east-1-058323655887/transformed/data/sentiment-test/', 'LocalPath': '/opt/ml/processing/input/data/', 'S3DataType': 'S3Prefix', 'S3InputMode': 'File', 'S3DataDistributionType': 'FullyReplicated', 'S3CompressionType': 'None'}}, {'InputName': 'code', 'AppManaged': False, 'S3Input': {'S3Uri': 's3://sagemaker-us-east-1-058323655887/sagemaker-scikit-learn-2023-02-13-18-04-08-342/input/code/evaluate_model_metrics.py', 'LocalPath': '/opt/ml/processing/input/code', 'S3DataType': 'S3Prefix', 'S3InputMode': 'File', 'S3DataDistributionType': 'FullyReplicated', 'S3CompressionType': 'None'}}]
Outputs:  [{'OutputName': 'metrics', 'AppManaged': False, 'S3Output': {'S3Uri': 's3://sagemaker-us-east-1-058323655887/sagemaker-scikit-learn-2023-02-13-18-04-08-342/output/metrics', 'LocalPath': '/opt/ml/processing/output/metrics', 'S3UploadMode': 'EndOfJob'}}]
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see the information about the Processing Jobs using the <code>describe</code> function. The result is in dictionary format. Let's pull the Processing Job name:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">scikit_processing_job_name</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()[</span><span class="s2">"ProcessingJobName"</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'Processing Job name: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scikit_processing_job_name</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Processing Job name: sagemaker-scikit-learn-2023-02-13-18-04-08-342
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now lets pull the Processing Job status from the Processing Job description.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">processor</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>dict_keys(['ProcessingInputs', 'ProcessingOutputConfig', 'ProcessingJobName', 'ProcessingResources', 'StoppingCondition', 'AppSpecification', 'RoleArn', 'ProcessingJobArn', 'ProcessingJobStatus', 'LastModifiedTime', 'CreationTime', 'ResponseMetadata'])
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">scikit_processing_job_status</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()[</span><span class="s1">'ProcessingJobStatus'</span><span class="p">]</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">'Processing job status: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scikit_processing_job_status</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Processing job status: InProgress
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's monitor the Processing Job.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="n">running_processor</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">ProcessingJob</span><span class="o">.</span><span class="n">from_processing_name</span><span class="p">(</span>
    <span class="n">processing_job_name</span><span class="o">=</span><span class="n">scikit_processing_job_name</span><span class="p">,</span> <span class="n">sagemaker_session</span><span class="o">=</span><span class="n">sess</span>
<span class="p">)</span>

<span class="n">processing_job_description</span> <span class="o">=</span> <span class="n">running_processor</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

<span class="n">pprint</span><span class="p">(</span><span class="n">processing_job_description</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{'AppSpecification': {'ContainerArguments': ['--max-seq-length', '128'],
                      'ContainerEntrypoint': ['python3',
                                              '/opt/ml/processing/input/code/evaluate_model_metrics.py'],
                      'ImageUri': '683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:0.23-1-cpu-py3'},
 'CreationTime': datetime.datetime(2023, 2, 13, 18, 4, 9, 1000, tzinfo=tzlocal()),
 'LastModifiedTime': datetime.datetime(2023, 2, 13, 18, 4, 9, 766000, tzinfo=tzlocal()),
 'ProcessingInputs': [{'AppManaged': False,
                       'InputName': 'model-tar-s3-uri',
                       'S3Input': {'LocalPath': '/opt/ml/processing/input/model/',
                                   'S3CompressionType': 'None',
                                   'S3DataDistributionType': 'FullyReplicated',
                                   'S3DataType': 'S3Prefix',
                                   'S3InputMode': 'File',
                                   'S3Uri': 's3://sagemaker-us-east-1-058323655887/pytorch-training-230213-1736-002-23e15b91/output/model.tar.gz'}},
                      {'AppManaged': False,
                       'InputName': 'evaluation-data-s3-uri',
                       'S3Input': {'LocalPath': '/opt/ml/processing/input/data/',
                                   'S3CompressionType': 'None',
                                   'S3DataDistributionType': 'FullyReplicated',
                                   'S3DataType': 'S3Prefix',
                                   'S3InputMode': 'File',
                                   'S3Uri': 's3://sagemaker-us-east-1-058323655887/transformed/data/sentiment-test/'}},
                      {'AppManaged': False,
                       'InputName': 'code',
                       'S3Input': {'LocalPath': '/opt/ml/processing/input/code',
                                   'S3CompressionType': 'None',
                                   'S3DataDistributionType': 'FullyReplicated',
                                   'S3DataType': 'S3Prefix',
                                   'S3InputMode': 'File',
                                   'S3Uri': 's3://sagemaker-us-east-1-058323655887/sagemaker-scikit-learn-2023-02-13-18-04-08-342/input/code/evaluate_model_metrics.py'}}],
 'ProcessingJobArn': 'arn:aws:sagemaker:us-east-1:058323655887:processing-job/sagemaker-scikit-learn-2023-02-13-18-04-08-342',
 'ProcessingJobName': 'sagemaker-scikit-learn-2023-02-13-18-04-08-342',
 'ProcessingJobStatus': 'InProgress',
 'ProcessingOutputConfig': {'Outputs': [{'AppManaged': False,
                                         'OutputName': 'metrics',
                                         'S3Output': {'LocalPath': '/opt/ml/processing/output/metrics',
                                                      'S3UploadMode': 'EndOfJob',
                                                      'S3Uri': 's3://sagemaker-us-east-1-058323655887/sagemaker-scikit-learn-2023-02-13-18-04-08-342/output/metrics'}}]},
 'ProcessingResources': {'ClusterConfig': {'InstanceCount': 1,
                                           'InstanceType': 'ml.c5.2xlarge',
                                           'VolumeSizeInGB': 30}},
 'ResponseMetadata': {'HTTPHeaders': {'content-length': '2328',
                                      'content-type': 'application/x-amz-json-1.1',
                                      'date': 'Mon, 13 Feb 2023 18:04:09 GMT',
                                      'x-amzn-requestid': '27108fc5-7782-41b6-ac72-25de5e9245dc'},
                      'HTTPStatusCode': 200,
                      'RequestId': '27108fc5-7782-41b6-ac72-25de5e9245dc',
                      'RetryAttempts': 0},
 'RoleArn': 'arn:aws:iam::058323655887:role/sagemaker-studio-vpc-firewall-us-east-1-sagemaker-execution-role',
 'StoppingCondition': {'MaxRuntimeInSeconds': 7200}}
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>

<span class="n">running_processor</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">logs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>.........................................................................!CPU times: user 338 ms, sys: 40.8 ms, total: 379 ms
Wall time: 6min 9s
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Inspect-the-processed-output-data">
<a class="anchor" href="#Inspect-the-processed-output-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Inspect the processed output data<a class="anchor-link" href="#Inspect-the-processed-output-data"> </a>
</h3>
<p>Let's take a look at the results of the Processing Job. Get the S3 bucket location of the output metrics:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">processing_job_description</span> <span class="o">=</span> <span class="n">running_processor</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

<span class="n">output_config</span> <span class="o">=</span> <span class="n">processing_job_description</span><span class="p">[</span><span class="s2">"ProcessingOutputConfig"</span><span class="p">]</span>
<span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">output_config</span><span class="p">[</span><span class="s2">"Outputs"</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="s2">"OutputName"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"metrics"</span><span class="p">:</span>
        <span class="n">processed_metrics_s3_uri</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">"S3Output"</span><span class="p">][</span><span class="s2">"S3Uri"</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">processed_metrics_s3_uri</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>s3://sagemaker-us-east-1-058323655887/sagemaker-scikit-learn-2023-02-13-18-04-08-342/output/metrics
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>List the content of the folder:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>aws s3 ls <span class="nv">$processed_metrics_s3_uri</span>/
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2023-02-13 18:10:13      21764 confusion_matrix.png
2023-02-13 18:10:13         56 evaluation.json
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The test accuracy can be pulled from the <code>evaluation.json</code> file.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="n">metrics_json</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">S3Downloader</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">"</span><span class="si">{}</span><span class="s2">/evaluation.json"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">processed_metrics_s3_uri</span>
<span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'Test accuracy: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">metrics_json</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Test accuracy: {'metrics': {'accuracy': {'value': 0.7378640776699029}}}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Copy image with the confusion matrix generated during the model evaluation into the folder <code>generated</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>aws s3 cp <span class="nv">$processed_metrics_s3_uri</span>/confusion_matrix.png ./generated/

<span class="kn">import</span> <span class="nn">time</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># Slight delay for our notebook to recognize the newly-downloaded file</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>download: s3://sagemaker-us-east-1-058323655887/sagemaker-scikit-learn-2023-02-13-18-04-08-342/output/metrics/confusion_matrix.png to generated/confusion_matrix.png
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Lets show and review the confusion matrix, which is a table of all combinations of true (actual) and predicted labels. Each cell contains the number of the reviews for the corresponding sentiments.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/confusion_matrix.png" alt="" title="Confusion Matrix"></p>
<p>We can see that the highest numbers of the reviews appear in the diagonal cells, which are the correct predictions for each sentiment class.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Acknowledgements">
<a class="anchor" href="#Acknowledgements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Acknowledgements<a class="anchor-link" href="#Acknowledgements"> </a>
</h2>
<p>I'd like to express my thanks to the great <a href="https://www.deeplearning.ai/courses/practical-data-science-specialization/">Deep Learning AI Practical Data Science on AWS Specialisation Course</a> which i completed, and acknowledge the use of some images and other materials from the training course in this article.</p>

</div>
</div>
</div>
</div>



  </div>
  
  <a class="u-url" href="/aws/cloud-data-science/natural-language-processing/deep-learning/2023/02/14/optimize-models-in-the-cloud-using-aws-automatic-model-tuning.html" hidden></a>
</article><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="pranath/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>